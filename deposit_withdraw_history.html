<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            position: relative;
        }
        .header h1 {
            font-size: 26px;
            color: #333;
            margin: 0;
            text-align: center;
        }
        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #555;
            text-decoration: none;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        .history-section {
            margin-bottom: 25px;
        }
        .history-section h2 {
            font-size: 22px;
            color: #444;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .transaction-list {
            list-style: none;
            padding: 0;
        }
        .transaction-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .transaction-info {
            flex-grow: 1;
        }
        .transaction-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        .status {
            font-weight: bold;
            text-transform: uppercase;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            font-size: 12px;
        }
        .status-pending {
            background-color: #ffc107;
            color: #333;
        }
        .status-approved {
            background-color: #28a745;
        }
        .status-rejected {
            background-color: #dc3545;
        }
        .message {
            text-align: center;
            font-size: 14px;
            margin-top: 20px;
        }
        .error {
            color: red;
        }
        .no-records {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="#" class="back-btn" onclick="goBack()">&#8592;</a>
        <h1>Transaction History</h1>
    </div>

    <div class="message" id="status-message">Loading user data...</div>
    
    <div class="history-section">
        <h2>Recent History</h2>
        <ul id="transaction-list" class="transaction-list">
        </ul>
        <p id="no-transactions" class="no-records" style="display: none;">No transaction records found.</p>
    </div>
</div>

<script>
    // Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCS5HN0yT3e7el75fBc2HLcLmTnrcQZ7bc",
      authDomain: "exsurvey-1c78a.firebaseapp.com",
      databaseURL: "https://exsurvey-1c78a-default-rtdb.firebaseio.com",
      projectId: "exsurvey-1c78a",
      storageBucket: "exsurvey-1c78a.firebasestorage.app",
      messagingSenderId: "754959615386",
      appId: "1:754959615386:web:65c390db232a7dafd3e623",
      measurementId: "G-8SQNS2DLBT"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // UI Elements
    const statusMessage = document.getElementById('status-message');
    const transactionList = document.getElementById('transaction-list');
    const noTransactionsMsg = document.getElementById('no-transactions');

    let currentUserId = null;
    let currentUsername = null;
    
    // Check if a user is logged in
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            currentUserId = user.uid;
            
            const userRef = database.ref('users/' + currentUserId);
            userRef.once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData && userData.username) {
                    currentUsername = userData.username;
                    statusMessage.textContent = 'Transaction history loading...';
                    fetchTransactions();
                } else {
                    statusMessage.textContent = 'User data not found.';
                    statusMessage.classList.add('error');
                }
            }, (error) => {
                console.error("Firebase Read Error:", error);
                statusMessage.textContent = 'Failed to load user data.';
                statusMessage.classList.add('error');
            });
        } else {
            statusMessage.textContent = 'You are not logged in. Please log in to view your history.';
            statusMessage.classList.add('error');
        }
    });

    // Function to fetch and display all transactions
    function fetchTransactions() {
        if (!currentUsername) {
            return;
        }
        
        const transactionRef = database.ref('deposit_withdraw_request')
            .orderByChild('username').equalTo(currentUsername);

        transactionRef.on('value', (snapshot) => {
            let allTransactions = [];
            snapshot.forEach((childSnapshot) => {
                const transaction = childSnapshot.val();
                allTransactions.push(transaction);
            });
            
            allTransactions.sort((a, b) => b.timestamp - a.timestamp);
            
            renderTransactions(allTransactions);
        }, (error) => {
            console.error("Firebase Read Error:", error);
            statusMessage.textContent = 'Failed to load transaction data.';
            statusMessage.classList.add('error');
        });
    }

    // Generic function to render a combined list of transactions
    function renderTransactions(transactions) {
        transactionList.innerHTML = '';
        if (transactions.length > 0) {
            noTransactionsMsg.style.display = 'none';
            transactions.forEach((transaction) => {
                const li = document.createElement('li');
                li.classList.add('transaction-item');

                const statusClass = getStatusClass(transaction.status);
                const date = new Date(transaction.timestamp).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' });
                
                let bdtAmountHtml = '';
                // Check transaction type and use the correct BDT amount field
                if (transaction.type === 'withdraw' && transaction.bdtAmount) {
                    bdtAmountHtml = `<p><strong>BDT Amount:</strong> ৳ ${transaction.bdtAmount}</p>`;
                } else if (transaction.type === 'deposit' && transaction.amount_bdt) {
                    bdtAmountHtml = `<p><strong>BDT Amount:</strong> ৳ ${transaction.amount_bdt}</p>`;
                }
                
                let detailsHtml = '';
                if (transaction.type === 'withdraw' && transaction.accountNo) {
                    detailsHtml = `<p><strong>Withdrawal Account No:</strong> ${transaction.accountNo}</p>`;
                } else if (transaction.type === 'deposit' && transaction.transactionId) {
                    detailsHtml = `<p><strong>Transaction ID:</strong> ${transaction.transactionId}</p>`;
                }

                li.innerHTML = `
                    <div class="transaction-info">
                        <p><strong>Type:</strong> ${transaction.type}</p>
                        <p><strong>Amount:</strong> $${transaction.amount}</p>
                        ${bdtAmountHtml}
                        <p><strong>Method:</strong> ${transaction.method}</p>
                        ${detailsHtml}
                        <p><strong>Date:</strong> ${date}</p>
                    </div>
                    <span class="status ${statusClass}">${transaction.status}</span>
                `;
                transactionList.appendChild(li);
            });
        } else {
            noTransactionsMsg.style.display = 'block';
        }
        statusMessage.textContent = '';
    }

    // Helper function to get status class
    function getStatusClass(status) {
        const lowerStatus = status.toLowerCase();
        if (lowerStatus === 'approved') {
            return 'status-approved';
        } else if (lowerStatus === 'rejected' || lowerStatus.includes('rejected')) {
            return 'status-rejected';
        } else {
            return 'status-pending';
        }
    }
    
    // Back button functionality
    function goBack() {
        window.history.back();
    }
</script>

</body>
</html>
